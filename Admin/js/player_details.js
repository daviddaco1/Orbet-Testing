// const user = {
//     userInfo: {
//         fullName: "Andres Ortiz",
//         currentCountry: "CA",
//         signInAt: "2024-10-01 15:28:13",
//         signInIp: "127.0.0.1",
//         createdAt: "2024-10-01 15:28:13",
//         createdIn: "CA",
//         confirmedAt: "2024-10-01 15:28:13",
//         twoFactorAuth: "NO",
//         termsAcceptedAt: "Oct 01, 2024"
//     },
//     userExtraInfo: {
//         app: "casino",
//         person: "38997625",
//         customerio: "orbet:4086",
//         googleAnalytics: "46a19421-52f7-4cc9-897a-553dd4eb0427",
//         lastTrackedCountry: "CA",
//         lastTrackedCountryRegion: "AB",
//         pspTrustedLevel: "trusted_verified"
//     },
//     userAdArgsInfo: {
//         ga: "46a19421-52f7-4cc9-897a-553dd4eb0427",
//         utmSource: null,
//         utmMedium: null,
//         utmCampaign: null,
//         utmContent: null,
//         utmTerm: null,
//         stagAffiliate: null,
//         stagVisit: null,
//         btag: null,
//         btagNetRefer: null,
//         qtag: null,
//         refCode: null
//     },
//     userDetailsInfo: {
//         personalIdNumber: null,
//         firstName: "Andres",
//         lastName: "Ortiz",
//         nickname: "daviddaco1",
//         dateOfBirth: null,
//         gender: null,
//         country: "CA",
//         city: null,
//         address: null,
//         postalCode: null,
//         receiveEmailPromos: "YES",
//         receiveSmsPromos: "NO",
//         securityQuestion: null,
//         securityAnswer: null,
//         state: null,
//         mobilePhone: "+10002222222"
//     },
//     phoneInfo: [
//         {
//             number: "+10002222222",
//             status: "Active",
//             verification: "Not verified",
//             country: "Canada"
//         }
//         // Puedes agregar más números de teléfono aquí
//     ],
//     usedAddresses: [
//         {
//             currency: "CAD-USDC",
//             address: "0x111111111111111111111111111111111111111111111111"
//         },
//         {
//             currency: "CAD-BNB",
//             address: "0x222222222222222222222222222222222222222222222222"
//         },
//         {
//             currency: "CAD-ETH",
//             address: "0x333333333333333333333333333333333333333333333333"
//         }
//         // Puedes agregar más direcciones aquí
//     ],
//     usedIPs: [
//         "127.0.0.1",
//         "127.0.0.2",
//         "127.0.0.3"
//         // Puedes agregar más IPs aquí
//     ],
//     status: 'activated',
//     accounts: [
//         {
//             id: 1,
//             currency: 'USD',
//             balance: 1000.00,
//             depositSum: 5000.00,
//             cashoutsSum: 3000.00,
//             pendingCashoutsSum: 150.00,
//             chargebacksSum: 20.00,
//             unreceivedDepositsSum: 0.00,
//             refundsSum: 50.00,
//             reversalsSum: 10.00,
//             affiliatePaymentsSum: 200.00,
//             avgBet: 10.00,
//             giftsSum: 5.00,
//             spentInCasino: 300.00,
//             bonuses: 100.00,
//             bonusRatio: 0.1
//         },
//         {
//             id: 2,
//             currency: 'EUR',
//             balance: 800.00,
//             depositSum: 2500.00,
//             cashoutsSum: 1500.00,
//             pendingCashoutsSum: 75.00,
//             chargebacksSum: 10.00,
//             unreceivedDepositsSum: 5.00,
//             refundsSum: 25.00,
//             reversalsSum: 2.00,
//             affiliatePaymentsSum: 100.00,
//             avgBet: 8.00,
//             giftsSum: 3.00,
//             spentInCasino: 200.00,
//             bonuses: 50.00,
//             bonusRatio: 0.05
//         }
//     ],
//     compPoints: {
//         id: 1,
//         accountType: 'Standard', // Tipo de cuenta, puedes cambiarlo si es necesario
//         points: 150, // Puntos
//         micropoints: 50 // Micropuntos
//     },
//     bonuses: [
//         {
//             id: 1,
//             issuedAt: '2024-01-01',
//             bonusName: 'Welcome Bonus',
//             amount: 100.00,
//             strategy: 'First Deposit',
//             stage: 'Active',
//             amountLocked: 50.00,
//             wager: '25.00 / 25.00 USD (100 %)',
//             expiryDate: '2024-12-31',
//             relatedAccountId: 1 // Relacionar con la cuenta 1 (USD)
//         },
//         {
//             id: 2,
//             issuedAt: '2024-02-01',
//             bonusName: 'Loyalty Bonus',
//             amount: 50.00,
//             strategy: 'Monthly',
//             stage: 'Active',
//             amountLocked: 25.00,
//             wager: '15.00 / 15.00 USD (100 %)',
//             expiryDate: '2024-11-30',
//             relatedAccountId: 2 // Relacionar con la cuenta 2 (EUR)
//         }
//     ],
//     latestPayments: [
//         {
//             action: "Cashout",
//             source: "CoinsPaidv2",
//             account: "Account 1",
//             sourceOfApproval: "Admin 1",
//             manual: "No",
//             returnType: "Instant",
//             comments: "N/A",
//             sumsubPmv: "N/A",
//             success: "Yes",
//             createdAt: "2024-09-29T10:00:00Z",
//             finishedAt: "2024-09-29T10:05:00Z",
//             amount: 500.00,
//             relatedAccountId: 1 // Relacionar con la cuenta 1 (USD)
//         },
//         {
//             action: "Deposit",
//             source: "BinancePay",
//             account: "Account 2",
//             sourceOfApproval: "Admin 2",
//             manual: "No",
//             returnType: "Instant",
//             comments: "N/A",
//             sumsubPmv: "N/A",
//             success: "Yes",
//             createdAt: "2024-09-28T14:30:00Z",
//             finishedAt: "2024-09-28T14:35:00Z",
//             amount: 250.00,
//             relatedAccountId: 2 // Relacionar con la cuenta 2 (EUR)
//         }
//     ],
//     binInfo: [
//         {
//             currency: "USD",
//             system: "Visa",
//             account: "1234-5678-9123",
//             bankName: "Bank of America",
//             bankCountry: "USA",
//             stage: "Active",
//             cardType: "Credit",
//             relatedAccountId: 1 // Relacionar con la cuenta 1 (USD)
//         },
//         {
//             currency: "EUR",
//             system: "Mastercard",
//             account: "5678-9123-1234",
//             bankName: "Deutsche Bank",
//             bankCountry: "Germany",
//             stage: "Inactive",
//             cardType: "Debit",
//             relatedAccountId: 2 // Relacionar con la cuenta 2 (EUR)
//         },
//         {
//             currency: "GBP",
//             system: "Visa",
//             account: "9123-1234-5678",
//             bankName: "HSBC",
//             bankCountry: "United Kingdom",
//             stage: "Active",
//             cardType: "Credit"
//         }
//     ],
//     paymentSystemsDebts: [
//         {
//             createdAt: '2024-10-01T12:00:00',
//             updatedAt: '2024-10-02T08:00:00',
//             systemName: 'System A',
//             accountInSystem: 'Account1',
//             paymentAccount: 'PayAccount1',
//             currency: 'USD',
//             debit: 1000,
//             verified: true,
//             relatedAccountId: 1 // Relacionar con la cuenta 1 (USD)
//         },
//         {
//             createdAt: '2024-10-01T10:00:00',
//             updatedAt: '2024-10-02T06:00:00',
//             systemName: 'System B',
//             accountInSystem: 'Account2',
//             paymentAccount: 'PayAccount2',
//             currency: 'EUR',
//             debit: 500,
//             verified: false,
//             relatedAccountId: 2 // Relacionar con la cuenta 2 (EUR)
//         }
//     ],
//     netTotal: [
//         {
//             currency: 'USD',
//             totalBets: 1500.50,
//             totalWins: 1200.75,
//             bonuses: 100.00,
//             netTotal: 200.75,
//             payout: 80.00
//         },
//         {
//             currency: 'EUR',
//             totalBets: 1000.00,
//             totalWins: 800.00,
//             bonuses: 50.00,
//             netTotal: 150.00,
//             payout: 60.00
//         }
//     ],
//     latestEvents: [
//         {
//             date: '2024-09-29T10:30:00',
//             eventType: 'User signed out',
//             ip: '192.168.0.1',
//             county: 'Los Angeles',
//             address: '123 Main St',
//             coordinates: {
//                 latitude: '34.0522',
//                 longitude: '-118.2437'
//             }
//         },
//         {
//             date: '2024-09-30T08:15:00',
//             eventType: 'User used new IP',
//             ip: '203.0.113.5',
//             county: 'San Francisco',
//             address: '456 Market St',
//             coordinates: {
//                 latitude: '37.7749',
//                 longitude: '-122.4194'
//             }
//         }
//     ],
//     tournamentParticipations: [
//         {
//             id: 12345,
//             title: 'Spring Championship',
//             currency: 'USD',
//             tournamentBets: 2500,
//             points: 150,
//             gameCategory: 'Poker',
//             awardPlace: '1st',
//             confirmationRequired: true,
//             endAt: '2024-12-31T23:59:59'
//         },
//         {
//             id: 67890,
//             title: 'Summer Tournament',
//             currency: 'EUR',
//             tournamentBets: 1800,
//             points: 120,
//             gameCategory: 'Blackjack',
//             awardPlace: '3rd',
//             confirmationRequired: false,
//             endAt: '2024-08-31T23:59:59'
//         }
//     ],
//     documents: [
//         {
//             id: 1,
//             url: 'path/to/image.jpg',
//             type: 'image',
//             description: 'User Profile Picture',
//             createdAt: '2024-10-01T10:00:00Z',
//             updatedAt: '2024-10-01T10:00:00Z',
//             status: 'Approved',
//             isApproved: true,
//         },
//         {
//             id: 2,
//             url: 'path/to/document.pdf',
//             type: 'pdf',
//             description: 'Monthly Report',
//             createdAt: '2024-10-01T10:00:00Z',
//             updatedAt: '2024-10-01T10:00:00Z',
//             status: 'NotApproved',
//             isApproved: false,
//         },
//     ],
//     comments: [
//         {
//             adminEmail: "admin1@example.com",
//             date: "2024-10-02T12:00:00Z",
//             comment: "User requested a bonus adjustment."
//         },
//         {
//             adminEmail: "admin2@example.com",
//             date: "2024-10-01T14:00:00Z",
//             comment: "Account verification completed."
//         },
//     ],
//     csLocks: [
//         { reason: 'Cheating', comment: 'Using aimbot.' },
//         { reason: 'Toxic Behavior', comment: 'Harassment in chat.' }
//     ],
//     sbLocks: [
//         { reason: 'Account Sharing', comment: 'Sharing account with others.' },
//         { reason: 'Botting', comment: 'Using automated scripts.' }
//     ],
//     tags: [
//         "0CNC5 - refund",
//         "2FG4V - kyc"
//     ],
//     groups: [
//         "Group: Unranked",
//         "Group: No Sweden"
//     ]
// };

let user;

let availableTags = [];

let availableGroups = [];

const addGroupButton = document.getElementById('addGroupButton');
const groupInput = document.getElementById('groupInput');
const groupList = document.getElementById('groupList');
const groupSuggestions = document.getElementById('groupSuggestions');

const addTagButton = document.getElementById('addTagButton');
const tagInput = document.getElementById('tagInput');
const tagList = document.getElementById('tagList');
const suggestions = document.getElementById('suggestions');

getUsers();
function getUsers() {
    socketMain.emit("getUser", { id: localStorage.getItem('selectedUser') });
    socketMain.emit("getTagsNGroups");
}

// Asegurarte de que el dropdown esté configurado correctamente con Bootstrap
document.addEventListener('DOMContentLoaded', function () {
    // Delegar el evento click en los items del dropdown
    dropdownMenu.addEventListener('click', function (event) {
        event.preventDefault(); // Prevenir comportamiento predeterminado de los enlaces

        // Verifica si el elemento clicado tiene la clase 'dropdown-item'
        if (event.target && event.target.classList.contains('dropdown-item')) {
            // Obtener el estado seleccionado del data attribute
            const newStatus = event.target.getAttribute('data-status');

            if (newStatus) {
                // Cambiar el texto del botón a la opción seleccionada
                statusButton.textContent = event.target.textContent;

                // Llamar a la función para enviar el nuevo estado al servidor
                changeUserStatus(newStatus);
            }
        }
    });

    // Asumimos que `socket` es una instancia de Socket.IO previamente conectada
    document.getElementById('submitReasonBtn').addEventListener('click', function () {
        const reasonUuid = document.getElementById('inputTextReason').value.trim();

        // Verifica si el UUID de la razón es válido
        if (reasonUuid) {
            socketMain.emit('setDuplications', { userId: localStorage.getItem('selectedUser'), reasonUuid: reasonUuid });
            console.log('Emitiendo duplicación con UUID de razón:', reasonUuid);
            showLoading();
        } else {
            alert('Por favor ingrese un UUID de razón válido');
        }
    });

    document.getElementById('submitUserIdBtn').addEventListener('click', function () {
        const otherUserId = document.getElementById('inputTextUserId').value.trim();

        // Verifica si el ID del usuario es válido
        if (otherUserId) {
            socketMain.emit('setDuplications', { userId: localStorage.getItem('selectedUser'), otherUserId: otherUserId });
            console.log('Emitiendo duplicación con ID de usuario:', localStorage.getItem('selectedUser'));
            showLoading();
        } else {
            alert('Por favor ingrese un ID de usuario válido');
        }
    });

    // Obtener referencias a los elementos del DOM
    const affiliateUrlInput = document.getElementById('affiliateUrlInput');
    const assignStagButton = document.getElementById('assignStagButton');
    const assignResponse = document.getElementById('assignResponse');

    assignStagButton.addEventListener('click', () => {
        const affiliateUrl = affiliateUrlInput.value.trim(); // Obtén el valor del input

        // Validar que el campo no esté vacío
        if (!affiliateUrl) {
            assignResponse.textContent = 'Please enter a valid affiliate URL.';
            assignResponse.style.color = 'red';
            return;
        }

        // Emitir el evento al servidor
        socketMain.emit('assignAffiliate', { userId: localStorage.getItem('selectedUser'), affiliateUrl });
    });
});

function loadAllTagsNGroups() {
    // Evento para el input de etiquetas
    tagInput.addEventListener('input', function () {
        const value = tagInput.value.toLowerCase();
        suggestions.innerHTML = '';

        if (user.tags == null) {
            user.tags = [];
        }

        if (value) {
            const filteredTags = availableTags.filter(tag =>
                tag.tag_name.toLowerCase().includes(value) &&
                !user.tags.some(userTag => userTag.tag_id === tag.tag_id) // No mostrar etiquetas ya seleccionadas
            );

            filteredTags.forEach(tag => {
                const suggestionItem = document.createElement('li');
                suggestionItem.classList.add('list-group-item', 'suggestion-item');
                suggestionItem.textContent = tag.tag_name;
                suggestionItem.onclick = function () {
                    addTag(tag);
                };
                suggestions.appendChild(suggestionItem);
            });

            suggestions.style.display = filteredTags.length ? 'block' : 'none';
        } else {
            suggestions.style.display = 'none';
        }
    });

    // Evento para el input de grupos
    groupInput.addEventListener('input', function () {
        const value = groupInput.value.toLowerCase();
        groupSuggestions.innerHTML = '';

        if (user.groups == null) {
            user.groups = [];
        }

        if (value) {
            const filteredGroups = availableGroups.filter(group =>
                group.group_name.toLowerCase().includes(value) &&
                !user.groups.some(userGroup => userGroup.group_id === group.group_id) // No mostrar grupos ya seleccionados
            );

            filteredGroups.forEach(group => {
                const suggestionItem = document.createElement('li');
                suggestionItem.classList.add('list-group-item', 'suggestion-item');
                suggestionItem.textContent = group.group_name;
                suggestionItem.onclick = function () {
                    addGroup(group);
                };
                groupSuggestions.appendChild(suggestionItem);
            });

            groupSuggestions.style.display = filteredGroups.length ? 'block' : 'none';
        } else {
            groupSuggestions.style.display = 'none';
        }
    });

    addTagsNGroups();
}

function addTag(tag) {
    // Verifica si el tag ya fue añadido
    const existingTags = Array.from(tagList.getElementsByTagName('span'));
    if (existingTags.some(existingTag => Number(existingTag.dataset.tag_id) === Number(tag.tag_id))) {
        tagInput.value = '';
        return; // No añadir si ya existe
    }

    // Crear un nuevo elemento para el tag
    const tagItem = document.createElement('span');
    tagItem.classList.add('badge', 'bg-primary', 'me-1', 'tag-item');
    tagItem.textContent = tag.tag_name;
    tagItem.dataset.tag_id = String(tag.tag_id); // Almacena el id en data-attribute como string

    // Añadir botón de eliminar
    const removeButton = document.createElement('button');
    removeButton.classList.add('btn-close', 'btn-close-white', 'btn-sm', 'ms-2');
    removeButton.onclick = function () {
        tagItem.remove();
        // Eliminar el tag de user.tags por id
        user.tags = user.tags.filter(t => Number(t.tag_id) !== Number(tag.tag_id));
    };

    tagItem.appendChild(removeButton);
    tagList.appendChild(tagItem);
    tagInput.value = '';

    // Agregar tag al array de user.tags como objeto {id, name}
    if (!user.tags) user.tags = []; // Inicializar si es null
    if (!user.tags.some(existingTag => Number(existingTag.tag_id) === Number(tag.tag_id))) {
        user.tags.push({ tag_id: tag.tag_id, tag_name: tag.tag_name });
    }

    suggestions.style.display = 'none'; // Ocultar sugerencias
}

function addGroup(group) {
    // Verifica si el grupo ya fue añadido
    const existingGroups = Array.from(groupList.getElementsByTagName('span'));
    if (existingGroups.some(existingGroup => Number(existingGroup.dataset.group_id) === Number(group.group_id))) {
        groupInput.value = '';
        return; // No añadir si ya existe
    }

    // Crear un nuevo elemento para el grupo
    const groupItem = document.createElement('span');
    groupItem.classList.add('badge', 'bg-dark', 'me-1', 'group-item');
    groupItem.textContent = group.group_name;
    groupItem.dataset.group_id = String(group.group_id); // Almacena el id en data-attribute como string

    // Añadir botón de eliminar
    const removeButton = document.createElement('button');
    removeButton.classList.add('btn-close', 'btn-close-white', 'btn-sm', 'ms-2');
    removeButton.onclick = function () {
        groupItem.remove();
        // Eliminar el grupo de user.groups por id
        user.groups = user.groups.filter(g => Number(g.group_id) !== Number(group.group_id));
    };

    groupItem.appendChild(removeButton);
    groupList.appendChild(groupItem);
    groupInput.value = '';

    // Agregar tag al array de user.tags como objeto {id, name}
    if (!user.groups) user.groups = []; // Inicializar si es null
    if (!user.groups.some(existingGroup => Number(existingGroup.group_id) === Number(group.group_id))) {
        user.groups.push({ group_id: group.group_id, group_name: group.group_name });
    }
    groupSuggestions.style.display = 'none'; // Ocultar sugerencias
}

function loadUser() {
    user = JSON.parse(localStorage.getItem('user'));
    loadAccount();
    loadIssuesEmptyBonuses();
    //loadCompPoints();
    loadBonuses();
    //populateTournamentParticipationsTable();
    updateAverageBonusRatio();
    populateBinInfoTable();
    populatePaymentSystemsTable();
    populateNetTotalTable();
    populateLatestEventsTable();
    populateDocumentsTable();
    populateCommentsList();
    displayUserInfo(user.userInfo);
    displayUserExtraInfo(user.userExtraInfo);
    displayUserAdArgs(user.userAdArgsInfo);
    displayUserDetails(user.userDetailsInfo);
    displayPhoneList(user.phoneInfo);
    displayAddressList(user.usedAddresses);
    displayIPList(user.usedIPs);
    populateLatestPaymentsTable();
    populateBinInfoTable();
    setStatus();
    populateLocks();
    updatePromosStyles();
}

function loadAccount() {
    const tableBody = document.getElementById('accounts-table-body');
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    const bgClasses = [
        'bg-primary',
        'bg-secondary',
        'bg-success',
        'bg-danger',
        'bg-warning',
        'bg-info',
        'bg-light',
        'bg-dark'
    ];

    user.accounts.forEach(account => {
        const row = document.createElement('tr');

        // Seleccionar una clase aleatoria
        const randomClass = bgClasses[Math.floor(Math.random() * bgClasses.length)];

        row.innerHTML = `
            <td>${account.id}</td>
            <td class="${randomClass} p-1" style="white-space: nowrap;">${account.currency}</td>
            <td>${account.balance.toFixed(2)}</td>
            <td>${account.depositSum.toFixed(2)}</td>
            <td>${account.cashoutsSum.toFixed(2)}</td>
            <td>${account.pendingCashoutsSum.toFixed(2)}</td>
            <td>${account.chargebacksSum.toFixed(2)}</td>
            <td>${account.unreceivedDepositsSum.toFixed(2)}</td>
            <td>${account.refundsSum.toFixed(2)}</td>
            <td>${account.reversalsSum.toFixed(2)}</td>
            <td>${account.affiliatePaymentsSum.toFixed(2)}</td>
            <td>${account.avgBet.toFixed(2)}</td>
            <td>${account.giftsSum.toFixed(2)}</td>
            <td>${account.spentInCasino.toFixed(2)}</td>
            <td>${account.bonuses.toFixed(2)}</td>
            <td>${account.bonusRatio.toFixed(2)}</td>
        `;

        tableBody.appendChild(row);
    });
}

function loadIssuesEmptyBonuses() { 
    const tableBody = document.getElementById('empty-bonuses-table-body');
    tableBody.innerHTML = ''; // Limpiar contenido anterior

    // Supongamos que "bonuses" contiene los bonos vacíos emitidos
    if (!Array.isArray(user.Emptybonuses) || user.Emptybonuses.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="2" class="text-center">No issued empty bonuses found</td></tr>`;
        return;
    }

    user.Emptybonuses.forEach(bonus => {
        // Validación de los campos requeridos
        if (!bonus.id || !bonus.issued_at) return;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${bonus.id}</td>
            <td>${new Date(bonus.issued_at).toLocaleString()}</td>
        `;
        tableBody.appendChild(row);
    });
}

function updateAverageBonusRatio() {
    const totalBonusRatio = user.accounts.reduce((sum, account) => sum + account.bonusRatio, 0);
    const avgBonusRatio = totalBonusRatio / user.accounts.length || 0; // Evitar división por cero

    const avgBonusRatioElement = document.getElementById('avg-bonus-ratio');
    avgBonusRatioElement.innerText = `${(avgBonusRatio * 100).toFixed(2)}%`; // Convertir a porcentaje
}

function loadCompPoints() {
    const tableBody = document.getElementById('comp-points-table-body');
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${user.compPoints.id}</td>
        <td><a href="#" class="text-primary">History</a></td>
        <td>${user.compPoints.accountType}</td>
        <td>${user.compPoints.points}</td>
        <td>${user.compPoints.micropoints}</td>
    `;

    tableBody.appendChild(row);
}

function loadBonuses() {
    const tableBody = document.getElementById('bonuses-table-body');
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    user.bonuses.forEach(bonus => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td><a href="#" onclick="viewBonusDetails(${bonus.id})">${bonus.bonusName}</a></td>
            <td>${bonus.issuedAt}</td>
            <td>${bonus.amount.toFixed(2)} USD</td>
            <td>${bonus.strategy}</td>
            <td>${bonus.stage}</td>
            <td>${bonus.amountLocked.toFixed(2)} USD</td>
            <td>${bonus.wager}</td>
            <td>${bonus.expiryDate}</td>
        `;

        tableBody.appendChild(row);
    });
}

function populateLatestPaymentsTable() {
    const tableBody = document.getElementById('latest-payments-table-body'); // Asegúrate de que el ID sea correcto
    tableBody.innerHTML = ''; // Limpiar contenido anterior si es necesario

    user.latestPayments.forEach(payment => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${payment.action}</td>
            <td>${payment.source}</td>
            <td>${payment.account}</td>
            <td>${payment.sourceOfApproval}</td>
            <td>${payment.manual}</td>
            <td>${payment.returnType}</td>
            <td>${payment.comments}</td>
            <td>${payment.sumsubPmv}</td>
            <td class="${payment.success === 'yes' ? 'bg-success ps-3 pe-3 pt-2 pb-2 rounded mb-0' : 'bg-warning ps-3 pe-3 pt-2 pb-2 rounded mb-0'}" style="display: inline-block;">${payment.success.toUpperCase()}</td>
            <td>${new Date(payment.createdAt).toLocaleString()}</td>
            <td>${new Date(payment.finishedAt).toLocaleString()}</td>
            <td>${payment.amount} ${user.accounts[0].currency}</td>
        `;

        tableBody.appendChild(row);
    });
};

function populateBinInfoTable() {
    const tableBody = document.getElementById('bin-info-table-body'); // ID corregido
    tableBody.innerHTML = ''; // Limpiar contenido anterior si es necesario

    user.binInfo.forEach(info => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${info.currency}</td>
            <td>${info.system}</td>
            <td>${info.account}</td>
            <td>${info.bankName}</td>
            <td>${info.bankCountry}</td>
            <td>${info.stage}</td>
            <td>${info.cardType}</td>
        `;
        tableBody.appendChild(row);
    });
};

const populatePaymentSystemsTable = () => {
    const tableBody = document.getElementById('payment-systems-table-body'); // ID corregido
    tableBody.innerHTML = ''; // Limpiar contenido anterior si es necesario

    user.paymentSystemsDebts.forEach(debt => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(debt.createdAt).toLocaleString()}</td>
            <td>${new Date(debt.updatedAt).toLocaleString()}</td>
            <td>${debt.systemName}</td>
            <td>${debt.accountInSystem}</td>
            <td>${debt.paymentAccount}</td>
            <td>${debt.currency}</td>
            <td>${debt.debit}</td>
            <td>${debt.verified ? 'Yes' : 'No'}</td>
            <td>
                <ul class="list-inline">
                    <li class="btn btn-link list-inline-item"><a href="#">Verify</a></li>
                    <li class="btn btn-link list-inline-item"><a href="#">Reset</a></li>
                    <li class="btn btn-link list-inline-item"><a href="#">Changes history</a></li>
                </ul>
            </td>
        `;
        tableBody.appendChild(row);
    });
};

const populateNetTotalTable = () => {
    const tableBody = document.getElementById('net-total-table-body'); // ID corregido
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    user.netTotal.forEach(total => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${total.currency}</td>
            <td>${total.totalBets.toFixed(2)}</td>
            <td>${total.totalWins.toFixed(2)}</td>
            <td>${total.bonuses.toFixed(2)}</td>
            <td>${total.netTotal.toFixed(2)}</td>
            <td>${total.payout.toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
    });
};

const populateLatestEventsTable = () => {
    const tableBody = document.getElementById('latest-events-table-body'); // ID corregido
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    user.latestEvents.forEach(event => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(event.date).toLocaleString()}</td>
            <td>${event.eventType}</td>
            <td>${event.ip}</td>
            <td>${event.county}</td>
            <td>${event.address}</td>
            <td>${event.coordinates.latitude}, ${event.coordinates.longitude}</td>
        `;
        tableBody.appendChild(row);
    });
};

const populateTournamentParticipationsTable = () => {
    const tableBody = document.getElementById('tournament-participations-table-body');
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    user.tournamentParticipations.forEach(participation => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="viewTournamentDetails(${participation.id})">${participation.id}</a></td>
            <td><a href="#" onclick="viewTournamentTitle('${participation.title}')">${participation.title}</a></td>
            <td>${participation.currency}</td>
            <td>${participation.tournamentBets}</td>
            <td>${participation.points}</td>
            <td><a href="#" onclick="viewGameCategory('${participation.gameCategory}')">${participation.gameCategory}</a></td>
            <td>${participation.awardPlace}</td>
            <td>${participation.confirmationRequired === null || participation.confirmationRequired === undefined
                ? 'Not Applied'
                : participation.confirmationRequired
                    ? 'Yes'
                    : 'No'
            }</td>
            <td>${new Date(participation.endAt).toLocaleString()}</td>
        `;
        tableBody.appendChild(row);
    });
};

const populateDocumentsTable = () => {
    const tableBody = document.getElementById('documents-table-body');
    tableBody.innerHTML = ''; // Limpiar el contenido anterior

    user.documents.forEach(doc => {
        const row = document.createElement('tr');

        // Construir la URL completa para la preview
        const fileUrl = `http://34.30.25.172:3004/api/files/${doc.url}`;

        // Determinar el contenido de la vista previa
        let previewContent = `<a href="${fileUrl}" target="_blank">View Document</a>`
        if (doc.type === 'image') {
            // Vista previa para imágenes
            previewContent = `<img src="${fileUrl}" alt="${doc.description}" style="width: 100%; height: auto; object-fit: cover;">`;
        } else {
            // Otras vistas previas de documentos o enlaces
            previewContent = `<a href="${fileUrl}" target="_blank">View Document</a>`;
        }

        // Determinar la clase del estado
        const statusClass = doc.status === 'Approved' ? 'bg-success ps-3 pe-3 pt-2 pb-2 rounded mb-0' : 'bg-danger ps-3 pe-3 pt-2 pb-2 rounded mb-0';

        row.innerHTML = `
            <td>${previewContent}</td>
            <td>${doc.type}</td>
            <td>${doc.description}</td>
            <td>${new Date(doc.createdAt).toLocaleString()}</td>
            <td>${new Date(doc.updatedAt).toLocaleString()}</td>
            <td><span class="${statusClass}" style="display: inline-block;">${doc.status}</span></td>
            <td>
                <div class="d-flex flex-column">
                    <button class="btn btn-secondary rounded mb-1" onclick="commentDocument(${doc.id})">Comment</button>
                    <button class="btn btn-secondary rounded mb-1" onclick="toggleApproval(${doc.id})">${doc.isApproved ? 'Disapprove' : 'Approve'}</button>
                    <button class="btn btn-secondary rounded mb-1" onclick="deleteDocument(${doc.id})">Delete</button>
                    <button class="btn btn-secondary rounded mb-1" onclick="hideDocument(${doc.id})">Hide</button>
                </div>
            </td>
        `;
        tableBody.appendChild(row);
    });
};

const populateCommentsList = () => {
    const commentsList = document.getElementById('comments-list');
    commentsList.innerHTML = ''; // Limpiar la lista anterior

    user.comments.forEach(comment => {
        //console.log(JSON.stringify(comment))
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment mb-2 p-2 border rounded';
        commentDiv.innerHTML = `
            <strong>${comment.adminEmail} (${new Date(comment.date).toLocaleString()})</strong>
            <p>${comment.comment}</p>
        `;
        commentsList.appendChild(commentDiv);
    });

    document.getElementById('comments-count').innerText = `Showing ${user.comments.length} comments`;
    document.getElementById('comments-count-title').innerText = `Comments(${user.comments.length})`;
};

const addComment = () => {
    const newCommentText = document.getElementById('new-comment').value;
    if (newCommentText.trim() === '') return; // No agregar si el comentario está vacío

    const newComment = {
        userId_admin: 1, // Usar el correo real del admin
        user_id: localStorage.getItem('selectedUser'), // Obtener la fecha actual en formato ISO
        comment_text: newCommentText,
    };
    socketMain.emit("setComments", newComment);
    showLoading();
};

function setStatus() {
    const statusElement = document.getElementById('currentStatus');
    const statusButton = document.getElementById('statusButton');

    // Establecer el texto del badge y del botón basado en el estado actual
    if (user.userInfo.status === 'active') {
        statusElement.textContent = 'Active';
        statusButton.textContent = 'Activate';
    } else if (user.userInfo.status === 'suspended') {
        statusElement.textContent = 'Suspended';
        statusButton.textContent = 'Suspend';
    } else if (user.userInfo.status === 'disabled') {
        statusElement.textContent = 'Disabled';
        statusButton.textContent = 'Disable';
    }
}

function populateLocks() {
    const csTableBody = document.getElementById('cs-locks-table-body');
    const sbTableBody = document.getElementById('sb-locks-table-body');

    // Llenar las tablas de Locks según el tipo
    user.locks.forEach(lock => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${lock.reason}</td>
            <td>${lock.comment}</td>
        `;

        if (lock.type === 'csLocks') {
            csTableBody.appendChild(row); // Añadir a la tabla de CS Locks
        } else if (lock.type === 'sbLocks') {
            sbTableBody.appendChild(row); // Añadir a la tabla de SB Locks
        }
    });
}

function addTagsNGroups() {
    // Comprobar si tags no es null o undefined y tiene elementos
    if (user.tags && user.tags.length > 0) {
        // Cargar etiquetas ya seleccionadas al inicio
        user.tags.forEach(tag => {
            addTag(tag);
        });
    } else {
        console.log("No tags available.");
    }

    // Comprobar si groups no es null o undefined y tiene elementos
    if (user.groups && user.groups.length > 0) {
        // Cargar grupos ya seleccionados al inicio
        user.groups.forEach(group => {
            addGroup(group);
        });
    } else {
        console.log("No groups available.");
    }
}

function displayUserInfo(user) {
    const userInfoElements = document.querySelectorAll('.user-info');

    userInfoElements.forEach(element => {
        const key = element.getAttribute('data-key');
        const value = user[key];

        if (value) {
            element.textContent = value;
        } else {
            element.innerHTML = '<span class="text-muted">EMPTY</span>';
        }
    });
}

function displayUserExtraInfo(userExtra) {
    const userExtraInfoElements = document.querySelectorAll('.user-extra-info');

    userExtraInfoElements.forEach(element => {
        const key = element.getAttribute('data-key');
        const value = userExtra[key];

        if (value) {
            element.textContent = value;
        } else {
            element.innerHTML = '<span class="text-muted">EMPTY</span>';
        }
    });
}

function displayUserAdArgs(userAdArgs) {
    const userAdArgElements = document.querySelectorAll('.user-ad-arg');

    userAdArgElements.forEach(element => {
        const key = element.getAttribute('data-key');
        const value = userAdArgs[key];

        if (value) {
            element.textContent = value;
        } else {
            element.innerHTML = '<span class="text-muted">EMPTY</span>';
        }
    });
}

function displayUserDetails(userDetails) {
    const userDetailElements = document.querySelectorAll('.user-detail');

    userDetailElements.forEach(element => {
        const key = element.getAttribute('data-key');
        const value = userDetails[key];

        if (value) {
            element.textContent = value;
        } else {
            element.innerHTML = '<span class="text-muted">EMPTY</span>';
        }
    });

    // Manejar los valores de promociones de correo y SMS
    document.getElementById('emailPromos').textContent = userDetails.receiveEmailPromos;
    document.getElementById('smsPromos').textContent = userDetails.receiveSmsPromos;
}

function displayPhoneList(phones) {
    const phoneListElement = document.getElementById('phone-list');
    phoneListElement.innerHTML = ''; // Limpiar la lista existente

    phones.forEach(phone => {
        const listItem = document.createElement('li');
        listItem.className = 'fa fa-caret-right txt-secondary m-r-10';
        listItem.textContent = `${phone.number} (${phone.status}, ${phone.verification}) county: ${phone.country}`;
        phoneListElement.appendChild(listItem);
    });
}

function displayAddressList(addresses) {
    const addressTableBody = document.getElementById('address-table-body');
    addressTableBody.innerHTML = ''; // Limpiar la tabla existente

    addresses.forEach(item => {
        const row = document.createElement('tr');
        const currencyCell = document.createElement('td');
        currencyCell.className = 'bg-info p-1';
        currencyCell.style.whiteSpace = 'nowrap';
        currencyCell.textContent = item.currency;

        const addressCell = document.createElement('td');
        addressCell.className = 'p-1';
        const addressLink = document.createElement('a');
        addressLink.href = '#';
        addressLink.className = 'btn btn-link p-0 mb-0 text-truncate';
        addressLink.style.maxWidth = '150px';
        addressLink.style.display = 'inline-block';
        addressLink.textContent = item.address;

        addressCell.appendChild(addressLink);
        row.appendChild(currencyCell);
        row.appendChild(addressCell);
        addressTableBody.appendChild(row);
    });
}

function displayIPList(ips) {
    const ipListElement = document.getElementById('ip-list');
    ipListElement.innerHTML = ''; // Limpiar la lista existente

    ips.forEach(ip => {
        const listItem = document.createElement('li');
        listItem.style.whiteSpace = 'nowrap';

        const icon = document.createElement('i');
        icon.className = 'fa fa-caret-right txt-secondary m-r-10';

        const link = document.createElement('a');
        link.href = '#';
        link.className = 'btn btn-link mb-2';
        link.textContent = ip;

        listItem.appendChild(icon);
        listItem.appendChild(link);
        ipListElement.appendChild(listItem);
    });
}

addTagButton.addEventListener('click', function () {
    saveTags();
});

addGroupButton.addEventListener('click', function () {
    saveGroups();
});

function saveTags() {
    console.log(user.tags);
    socketMain.emit("setTags", { id: localStorage.getItem('selectedUser'), tags: user.tags });
    showLoading();
}

function saveGroups() {
    console.log(user.groups);
    socketMain.emit("setGroups", { id: localStorage.getItem('selectedUser'), groups: user.groups });
    showLoading();
}

// Función para mostrar la barra de carga
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

// Función para ocultar la barra de carga
function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Función para enviar el nuevo estado del usuario al servidor
function changeUserStatus(status) {
    socketMain.emit('changeUserStatus', { id: localStorage.getItem('selectedUser'), status });
    showLoading();
}

// Selecciona el botón y el menú del dropdown
const statusButton = document.getElementById('statusButton');
const dropdownMenu = document.getElementById('currencyDropdownMenu');

function updatePromosStyles() {
    // Obtener los elementos por ID
    const emailPromos = document.getElementById('emailPromos');
    const smsPromos = document.getElementById('smsPromos');

    // Verificar el innerText de cada elemento y actualizar las clases CSS
    if (emailPromos.innerText === 'YES') {
        emailPromos.classList.remove('bg-dark');
        emailPromos.classList.add('bg-secondary');
    } else {
        emailPromos.classList.remove('bg-secondary');
        emailPromos.classList.add('bg-dark');
    }

    if (smsPromos.innerText === 'YES') {
        smsPromos.classList.remove('bg-dark');
        smsPromos.classList.add('bg-secondary');
    } else {
        smsPromos.classList.remove('bg-secondary');
        smsPromos.classList.add('bg-dark');
    }
}

//Modal para suspiscion
// Obtener los elementos del DOM
const modal = document.getElementById('suspicionModal');
const openModalBtn = document.getElementById('openModalBtn'); // Asegúrate de que el ID coincida con el HTML
const closeModalBtn = document.getElementsByClassName('suspicion-modal-close')[0]; // Cambiado a suspicion-modal-close
const cancelBtn = document.getElementById('cancelBtn');
const confirmBtn = document.getElementById('confirmBtn');
const suspicionComment = document.getElementById('suspicionComment');

// Abrir el modal
openModalBtn.onclick = function () {
    suspicionComment.value = '';  // Limpiar el campo de texto
    modal.style.display = 'block';
}

// Cerrar el modal con la "X"
closeModalBtn.onclick = function () {
    modal.style.display = 'none';
}

// Cerrar el modal con el botón "Cancel"
cancelBtn.onclick = function () {
    modal.style.display = 'none';
}

// Acción al presionar "Confirm"
confirmBtn.onclick = function () {
    const comment = suspicionComment.value;
    if (comment.trim() === '') {
        alert('Por favor, ingrese un comentario.');
        return;
    }
    // Emitir el evento del socket con el comentario
    socketMain.emit("Setsuspicious", { id: localStorage.getItem('selectedUser'), failed_check_comment: comment });
    modal.style.display = 'none';
    showLoading();
}

// Cerrar el modal al hacer clic fuera del contenido
window.onclick = function (event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

function openModal(modalId) {
    document.getElementById(modalId).style.display = "block";
}

// Add event listeners to buttons
document.getElementById("openIssuancePolicy").addEventListener("click", function () {
    openModal('modalIssuancePolicy');
});

document.getElementById("openIssueBonus").addEventListener("click", function () {
    openModal('modalIssueBonus');
});

document.getElementById("openIssuePersonalBonus").addEventListener("click", function () {
    openModal('modalIssuePersonalBonus');
});

document.getElementById("openIssueDSLBonus").addEventListener("click", function () {
    openModal('modalIssueDSLBonus');
});

document.getElementById("openIssueDSLCashoutCancelBonus").addEventListener("click", function () {
    openModal('modalIssueDSLCashoutCancelBonus');
});

// Function to close the modal (you should have a close button inside each modal)
function closeModal(modalId) {
    document.getElementById(modalId).style.display = "none";
}